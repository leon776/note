
最近在折腾electron打包，起先用了electron packager，配置起来很简单，但是在mac上无法打windows包，每次发布都要用虚拟机，非常痛苦而且只能打包dmg和exe（就是win下的绿色版软件）无法生成安装包。痛定思痛，决定一步到位用electron builder。
electron builder有几个好处：
1. 可以打包web内容为asar；
2. 可以生成windows下的nsis也就是安装程序，mac下dmg；
3. mac下可以打包windows（网上某些文章说不可以，估计是他们写文章的时候还不支持）；
4. 打包程序可以生成latest.yml，用于自动更新，不需要多次打包；
5. 支持autoupdate（基于好处2和4）

本篇先讲第一部分，在mac下打包应用，包括windows setup.exe和mac app/dmg。
## 安装 electron-builder
尝试多次用npm安装 electron-builder，各种报错，于是按照官方文档用yarn，一路顺利。
先安装yarn：
<pre lang="shell">brew install yarn</pre>
然后
<pre lang="shell">yarn add electron-builder --dev</pre>
## 打包mac应用
mac打包相对简单，依赖什么的都可以通过npm解决，最难搞的应该就是签名那部分，下面一一道来。
### 配置 electron-builder
先上一下我的配置，只讲我用到的部分，全部参数参看：[传送门](https://www.electron.build/configuration/configuration)
scripts部分：<pre lang="shell">{"macpack": "cross-env NODE_ENV=production electron-builder -mac"}</pre>
build部分：<pre lang="shell">
"mac": {
      "icon": "assets/icon/icon.icns",
      "type": "distribution", 
      "target": [ "dmg", "zip"]
}</pre>
icon不用多说，应用程序图标，mac上用icns，[这里](http://www.img2icnsapp.com/)有制作工具，也可以用命令行：<pre lang="shell">iconutil -c icns --output assets/icon/icon.icns assets/icon/icon.iconset</pre>注：iconset里面图片的命名规则：从icon_16x16.png（16x16）到 icon_512x512@2x.png（1024x1024）。
type，2个值，distribution | development，这里对自动签名很关键，如果填distribution，那么打包的时候会用"Developer ID Application" identity签名，如果是development则会用"Mac Developer" identity。
target表示要生成dmg和zip，这个也是默认值，还可以填mas, mas-dev, pkg, 7z, tar.xz等。
### 签名
按照上述配置，执行打包命令，会报错“cannot find valid "Developer ID Application" identity or custom non-Apple code signing certificate” 或者 “cannot find valid "Mac Developer" identity or custom non-Apple code signing certificate”，意思是找不到可用的签名证书。我们要想办法搞到合适的证书，并加到钥匙串里，这样在执行打包命令的时候，会自动匹配到合适的证书并执行代码签名。 
#### 为什么要签名
Mac 下的 .dmg 安装包打开，首先会提示你「该应用来自身份不明的开发者，是否确认打开」，然后你点「确认」，再根据你的安全设定（系统偏好设置 —— 安全和隐私 —— 允许从以下位置的应用下的设置）去决定，而绝大部分的 Mac 用户都是勾选「App Store 和 被认证的开发者」，于是就算你点了「打开」，直接会告诉你「打不开XXX，因为它来自身份不明的开发者」，这个时候只能去改变「系统偏好设置 —— 安全和隐私 —— 允许从以下位置的应用下的设置」才能打开。
并且app签名也是执行autoUpdate的必要条件，否则会报错“Error: Could not get code signature for running application”。
#### 证书
证书分2种，免费和收费的。
 - 免费证书，免费证书只能本机调试用，但是也可以用来调试，签出来会是这样的效果：
       ![](http://leons-blog-cdn.b0.upaiyun.com/wp-content/uploads/2017/12/electron-builder/mac1.png)
    申请方法：打开钥匙串->证书助理->创建证书->类型选择代码签名
      ![](http://leons-blog-cdn.b0.upaiyun.com/wp-content/uploads/2017/12/electron-builder/mac2.png)
    创建成功以后，进入终端，打命令： security find-identity -v -p codesigning，如果能看到刚才创建的证书，比如这样：
     ![](http://leons-blog-cdn.b0.upaiyun.com/wp-content/uploads/2017/12/electron-builder/sh1.png) 
那么就成功了。
- 收费证书（有开发者账号）
    上面那张图的第一个证书就是收费证书，如果是独立开发者或者加入了Team，那么可以直接在xcode下申请。路径：Xcode —— Preference —— Account，选择或添加自己的apple ID，然后点击Manage Certificates。左下角会有一个加号，选择Mac Development或者Developer ID Application（根据刚才的package.json配置）。
- 收费证书（无开发者账号）
 不多说了，钥匙串->证书->从证书机构颁发证书，选生成CSR到disk，然后把生成的文件发给有权限进[https://developer.apple.com/account/mac/certificate/create](https://developer.apple.com/account/mac/certificate/create)的管理员，然后他会通过Upload CSR file.来生成一个p12证书发给你，双击安装到钥匙串即可。
有了证书以后，就可以执行打包命令了，如果只有一个证书，那么它会自己寻找合适的证书来签名。如果像我一样有多个证书，那么需要指定证书名字。方法是在打包命令前加上CSC_NAME，图中的"test"、""Developer ID Application xxxx"就是CSC_NAME。
<pre lang="shell">{"macpack": "cross-env NODE_ENV=production CSC_NAME='test' electron-builder -mac"}</pre>

#### 关于证书的坑
- 坑1：只有一个证书的时候如果指定了CSC_NAME会报错：Please remove prefix "Developer ID Application:" from the specified name — appropriate certificate will be chosen automatically。不用管它，不指定CSC_NAME即可。

- 坑2：不管是哪种方法，证书都是办法给当前登录mac的账户的，我一直用su root来执行打包命令，怎么搞都提示没有证书，坑了好久。
    是因为证书没有安装到/var/root/Library/Keychains，安装方法：
    > 1.先sudo su
    > 2.执行security create-keychain，一路按提示操作
    > 3.导出钥匙串里面的证书，会是一个p12文件，随便放哪。
    > 4.执行security import “步骤三导出的p12文件” -k /var/root/Library/Keychains/“步骤2创建的keychain名称” -P "步骤三导出p12文件的密码"。

- 坑3，官方文档，就是它：https://www.electron.build/code-signing，CSC_LINK和CSC_KEY_PASSWORD这俩 参数简直是坑，它实际上还是会导入CSC_LINK到当前执行命令的账户下，导致我的证书越来越多，还都是重复的，建议不要使用，太可怕了。后来我加上了DEBUG=electron-builder参数，看到它有删除这个导入的证书的命令，但是没成功，导致证书越来越多。wtf！最后手动删了， security delete-certificate -c 证书名。

- 坑4，如果build中指定type为development，那么自己的证书是无效的，Developer ID Application证书也是无效的，它只认Mac Developer证书，不管是指定了CSC_NAME还是CSC_LINK，我没解决，有大神搞定了欢迎留言。

- 坑5，基于坑4，如果sudo su了，导入Mac Developer证书以后，会报错CSSMERR_TP_NOT_TRUSTED，这个是因为root用户缺少很多根证书造成的，按照坑2的解法一个一个装吧。下载地址[http://www.apple.com/certificateauthority/](http://www.apple.com/certificateauthority/)。主要是Apple Woldwide Developer Relations Certification Authority和Apple Inc. Root Certificate。

## 打包windows应用
### 配置 electron-builder
配置好package.josn之后，执行打包命令，可想而知的会一路报错，主要是依赖问题，下面一个一个来解决。
### electron-builder依赖
#### 安装winCodeSign
我遇到报错“Cannot download winCodeSign, attempt #1: Error: Request timed out”，一看就是网络问题。解决方法有2种：404不存在和手动下载依赖包。404的方法就不讲了，下面说下怎么手动下载并安装依赖，后面几个包基本同理。
首先根据报错信息查路径，“⚠️  Cannot download winCodeSign, attempt #1: Error: Request timed out”。
在命令行执行<pre lang="shell">find / -name "*winCodeSign*" </pre>
查到了我本机的路径：/private/var/root/Library/Caches/electron-builder/winCodeSign
然后手动下载 [传送门](https://github.com/electron-userland/electron-builder-binaries/releases/tag/winCodeSign-1.9.0) 压缩包放到此路径下解压。
/private/var/root/Library/Caches/electron-builder/winCodeSign/winCodeSign-1.9.0/
#### 安装nsis-3.0.1.13
下载包地址[传送门](https://github.com/electron-userland/electron-builder-binaries/releases/tag/nsis-3.0.1.13)。
下载后执行命令，发现缺少文件/nsis-3.0.1.13/mac/makensis，没多想，下载后面的源码复制解决。
nsis的坑，用git上的压缩包解压，会提示少很多插件，我是这里一个一个下载的[http://nsis.sourceforge.net/WinShell_plug-in](http://nsis.sourceforge.net/WinShell_plug-in)
#### 安装nsis-resources
这个没遇到问题，下载地址[传送门](https://github.com/electron-userland/electron-builder-binaries/releases/tag/nsis-resources-3.0.0)。
#### 安装wine
这个比较麻烦，我的mac是10.12版本，所以命令行提示下载wine-2.0.1-mac-10.12，报错："⚠️  Cannot download wine, attempt #1: Error: Request timed out。Error: Request timed out at TLSSocket.socket.setTimeout"。
去git上下载对应的包，安装以后报错：“Error: Exit code: ENOENT. spawn /我的路径/wine-2.0.1-mac-10.12/bin/wine ENOENT”。
查了一下，是这个包少了文件bin/wine。
解决办法1：
brew安装wine（附1），然后ln -s软连接/usr/local/bin/wine到/我的路径/wine-2.0.1-mac-10.12/bin/wine 。
解决办法2：
在打包的时候加上参数USE_SYSTEM_WINE=true，使用系统的wine，修改package.json的scripts：
<pre lang="shell">{"winpack": "cross-env NODE_ENV=production USE_SYSTEM_WINE=true electron-builder -w"}</pre>

## 附
- mac安装wine的方法[传送门](https://www.davidbaumgold.com/tutorials/wine-mac/)
- security api文档：[传送门](https://developer.apple.com/library/content/documentation/Security/Conceptual/keychainServConcepts/01introduction/introduction.html)
- electron-builder官方文档 [传送门](https://www.electron.build/)
- 检查代码签名命令：codesign --display --verbose=4 文件名
